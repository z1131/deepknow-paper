# DeepWrite 后端系统架构设计

## 1. 代码架构 (Maven Monorepo)

项目采用 Maven 多模块单体仓库管理，支持模块化开发与分布式部署。

```text
dw-backend/
├── pom.xml                   # 父工程 (依赖版本管理)
├── dw-common/                # [Lib] 公共模块 (DTO, Utils, Constants)
├── dw-gateway/               # [App] 网关服务 (Spring Cloud Gateway)
├── dw-auth/                  # [App] 认证服务 (Auth & User)
└── dw-core/                  # [App] 核心业务服务 (Paper, Outline, AI)
    ├── src/main/java/com/deepwrite/core/
    │   ├── interfaces/       # 接口层 (Controller)
    │   ├── application/      # 应用层 (Service编排)
    │   ├── domain/           # 领域层 (Entity, Domain Service)
    │   └── infrastructure/   # 基础设施层 (Mapper, External Client)
```

## 2. 运行时架构 (Runtime Architecture)

```mermaid
graph TB
    subgraph "Client Side"
        FE[React Frontend]
    end

    subgraph "Gateway Layer (dw-gateway)"
        GW[Spring Cloud Gateway]
        Filter[Global Auth Filter]
        Route[Dynamic Router]
    end

    subgraph "Service Layer"
        AUTH[dw-auth (Auth Service)]
        CORE[dw-core (Writing Service)]
    end

    subgraph "Infrastructure"
        MySQL[(MySQL 8.0)]
        Redis[(Redis 7.x)]
        Nacos[Nacos 2.x (Registry/Config)]
        MQ[RocketMQ 5.x]
    end
    
    subgraph "External AI"
        Gemini[Google Gemini API]
    end

    FE -- HTTPS/WSS --> GW
    GW -- 1. Verify Token --> Filter
    Filter -- 2. Forward (UserHeader) --> Route
    
    Route -- /api/auth/* --> AUTH
    Route -- /api/core/* --> CORE
    Route -- /api/write/stream (SSE) --> CORE

    AUTH -- JDBC --> MySQL
    CORE -- JDBC (MyBatis-Plus) --> MySQL
    CORE -- Cache --> Redis
    
    CORE -- Spring AI --> Gemini
```

## 3. 核心设计原则

### 3.1 网关设计 (dw-gateway)
- **定位**: 纯技术网关，无业务逻辑。
- **职责**:
    - **统一鉴权**: 解析 JWT，将 `User-Id` 放入 Request Header 透传给后端。
    - **流式透传**: 完整支持 SSE (Server-Sent Events) 和 WebSocket 的长连接代理。
    - **限流熔断**: 集成 Sentinel 保护后端服务。

### 3.2 核心业务设计 (dw-core)
采用 **轻量级 DDD (Lightweight Domain-Driven Design)** 架构。

- **分层规范**:
    - **Interfaces (接口层)**: 处理 HTTP 请求，参数校验，调用 Application Service。
    - **Application (应用层)**: 流程编排，事务控制。**不包含核心业务规则**。
    - **Domain (领域层)**: 
        - **Entity (充血模型)**: 包含业务状态判断（如：只有大纲锁定的论文才能生成正文）。
        - **Domain Service**: 处理跨聚合的复杂逻辑。
        - **Repository Interface**: 定义数据存取接口（不依赖 MP）。
    - **Infrastructure (基础设施层)**: 
        - 实现 Repository 接口。
        - 使用 **MyBatis-Plus** 进行 CRUD。
        - 使用 **Spring AI** 调用大模型。

### 3.3 数据访问策略
- **简单查询**: 允许 Application 层直接调用 MyBatis-Plus 的 `Mapper/Service`。
- **复杂业务**: 必须通过 Domain 层 -> Repository -> Mapper XML 的路径，**禁止**在业务逻辑中拼接 MP 的 `QueryWrapper`。

## 4. 部署架构

- **容器化**: 每个服务 (`dw-gateway`, `dw-auth`, `dw-core`) 独立打包 Docker 镜像。
- **编排**: 本地开发使用 `docker-compose` 一键拉起中间件 (MySQL, Redis, Nacos, RocketMQ)。

---
架构更新日期: 2025-11-28
版本: v2.0.0 (Re-designed)