# DeepWrite 部署方案总结

## 1. 整体部署架构

我们采用了 **Docker 容器化 + 阿里云基础服务 + 双机分布式部署** 的混合架构。

### 1.1 服务器分工
- **ECS A (控制节点)**: `47.114.90.156` (内网: `172.17.150.78`)
  - **服务**: Nginx (前端), Nacos (注册中心), Gateway (网关), Auth (认证)。
  - **流量入口**: 所有公网流量 (HTTP/HTTPS) 先到达这里。
- **ECS B (计算节点)**: `47.99.32.144` (内网: `172.17.150.77`)
  - **服务**: Core (核心写作业务)。
  - **通信**: 通过内网 IP 与 ECS A 上的 Gateway/Nacos 通信。

### 1.2 数据存储 (阿里云 PaaS)
- **MySQL RDS**: `rm-xxxx.mysql.rds.aliyuncs.com`
- **Redis**: `r-xxxx.redis.rds.aliyuncs.com`

### 1.3 镜像仓库 (阿里云 ACR)
- **Registry**: `crpi-16uyo5eg9cykcl2r.cn-hangzhou.personal.cr.aliyuncs.com`
- **Namespace**: `deepwrite`
- **镜像列表**:
  - `dw-gateway`
  - `dw-auth`
  - `dw-core`
  - `dw-fronted` (前端)

## 2. 域名与流量转发

### 2.1 DNS 解析
- **记录**: `deepwrite.zzhper.cn` -> `47.114.90.156` (ECS A)

### 2.2 Nginx 转发策略 (ECS A)
- **访问前端**: `http://deepwrite.zzhper.cn/` -> Nginx 托管的静态文件 (React)
- **访问后端**: `http://deepwrite.zzhper.cn/api/` -> 反向代理到 `dw-gateway:8000`

## 3. GitHub Secrets 配置清单

### 3.1 后端仓库 (`dw-backend`)
| Secret Name | Value |
| :--- | :--- |
| `SERVER_HOST_A` | `47.114.90.156` |
| `SERVER_HOST_B` | `47.99.32.144` |
| `SERVER_USER` | `root` |
| `SERVER_SSH_KEY` | 私钥内容 (`ai_agent_key`) |
| `ALIYUN_ACR_USERNAME` | `aliyun6883918707` |
| `ALIYUN_ACR_PASSWORD` | 你的 ACR 密码 |

### 3.2 前端仓库 (`dw-fronted`)
| Secret Name | Value |
| :--- | :--- |
| `SERVER_HOST_A` | `47.114.90.156` |
| `SERVER_USER` | `root` |
| `SERVER_SSH_KEY` | 私钥内容 (`ai_agent_key`) |
| `ALIYUN_ACR_USERNAME` | `aliyun6883918707` |
| `ALIYUN_ACR_PASSWORD` | 你的 ACR 密码 |

## 4. 待办事项 (Next Steps)

### 服务器端 (ECS A & B)
- [ ] **安装环境**: Docker, Docker Compose (已提供脚本)。
- [ ] **创建目录**: `/opt/deepwrite/` 及其子目录。
- [ ] **配置 .env**: 复制 `.env.example` 到服务器，填入真实数据库密码。
- [ ] **安全组**: 确保 ECS A 开放 80/443/8080，ECS B 开放内网互通。

### 前端项目 (`dw-fronted`)
- [ ] **Dockerfile**: 编写前端构建脚本。
- [ ] **Nginx Config**: 放置 `nginx.conf`。
- [ ] **CI Workflow**: 配置 `.github/workflows/deploy-frontend.yml`。

### 后端项目 (`dw-backend`)
- [ ] **Push Code**: 推送代码触发 GitHub Actions。
