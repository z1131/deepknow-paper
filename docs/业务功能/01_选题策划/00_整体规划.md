# 01 选题策划 - 整体规划 (Refactored)

## 1. 核心理念与工作流

本阶段不仅仅是实现一个“AI 生成题目”的功能，而是 **DeepWrite 写作项目 (Project) 生命周期的启动阶段**。

### 核心工作流 (Workflow)
1.  **项目初始化**: 用户开始写作，系统隐式创建一个 `Project` 容器。
2.  **意图捕获**: 用户输入模糊的写作意图（Initial Idea）。
3.  **AI 发散**: 系统请求 AI 基于意图生成多组候选方案（Candidates）。
4.  **持久化展示**: 方案被保存，确保用户刷新页面或中断后能恢复现场。
5.  **决策/迭代**: 用户选择满意方案，或要求 AI 基于反馈重新生成。
6.  **状态锁定**: 用户确认方案，Project 锁定题目，状态流转至下一阶段。

---

## 2. 任务拆分 (Sub-tasks)

我们将 Phase 1 拆分为以下 4 个逻辑紧密、可独立验证的子任务：

### 子任务 1: 项目启动与状态管理 (Project Initialization)
-   **目标**: 建立 `Project` 实体作为核心容器，打通前后端对项目状态的同步。
-   **后端**: 
    -   设计 `project` 表。
    -   实现 `ProjectService` (创建、查询状态)。
    -   API: `POST /projects` (创建), `GET /projects/{id}` (查询)。
-   **前端**: 
    -   搭建 `WritingWorkspace` 基础布局。
    -   实现基于 Project 状态 (`INIT`, `TOPIC_GENERATED`, `TOPIC_SELECTED`) 的路由/视图切换逻辑。

### 子任务 2: AI 选题引擎 (AI Topic Engine)
-   **目标**: 实现稳定、结构化的 AI 题目生成能力，并持久化结果。
-   **后端**:
    -   设计 `topic_candidate` 表。
    -   封装 `GeminiClient`，设计 `TopicGenerationPrompt`。
    -   实现 `TopicService`：调用 AI -> 解析 JSON -> 存库。
    -   API: `POST /projects/{id}/topics/generate`。

### 子任务 3: 选题交互闭环 (Topic Selection UI/UX)
-   **目标**: 提供流畅的用户交互体验，完成从输入到确认的全过程。
-   **前端**:
    -   开发 `TopicInput` 组件 (输入意图)。
    -   开发 `TopicCardList` 组件 (展示候选卡片)。
    -   开发 `TopicConfirmation` 逻辑 (调用确认接口)。
-   **后端**:
    -   API: `POST /projects/{id}/topics/confirm` (更新 Project Title，流转状态)。
    -   支持“重新生成”逻辑 (保留 Project，追加/覆盖 Topic Candidates)。

### 子任务 4: 异常处理与兜底 (Resilience & Polish)
-   **目标**: 应对 AI 的不确定性和网络波动。
-   **后端**: 
    -   Gemini 调用超时处理与重试机制。
    -   AI 响应 JSON 解析失败的容错处理。
-   **前端**: 
    -   Loading 状态设计 (骨架屏/Spinner)。
    -   错误提示 (Toast) 与重试引导。

---

## 3. 核心决策与规范

### 3.1 状态流转定义
-   `INIT`: 项目刚创建，仅有 `userId`，无 `title`。
-   `TOPIC_GENERATED`: 已生成候选题目，用户正在挑选。
-   `TOPIC_SELECTED`: 用户已确认题目，Project `title` 已定。

### 3.2 AI 交互模式
-   **同步 vs 异步**: 考虑到题目生成通常较短（<10s），Phase 1 暂时采用 **同步 HTTP** 接口。Phase 3 (正文生成) 再引入 SSE。
-   **数据格式**: 强制 AI 输出纯 JSON 数组，后端进行严格 Schema 校验。

### 3.3 前端架构
-   **状态管理**: 使用 React Context 或 Zustand 管理当前 Project 的全局状态，避免 Prop Drilling。
-   **组件复用**: 题目卡片组件应设计为“纯展示组件”，逻辑下沉到父容器。